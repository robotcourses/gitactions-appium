name: Continuous Integration
on: [push, pull_request]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout AppiumLibrary repo
        uses: actions/checkout@v3
        with:
          path: rf-al

      - name: Use Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: 3.9
          cache: 'pip'

      - name: Install Dependencies
        run:
          pip install -r rf-al/requirements.txt

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 'lts/*'

      - name: Use Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          log-accepted-android-sdk-licenses: 'false'

      - name: Install additional Android SDK Packages
        run: |
          sdkmanager 'emulator'
          echo "$ANDROID_SDK_ROOT/emulator" >> $GITHUB_PATH
          sdkmanager --list_installed

      - name: Debug Android SDK Install
        run: |
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
          ls $ANDROID_SDK_ROOT
          ls $ANDROID_HOME
          grep -E -c '(vmx|svm)' /proc/cpuinfo

      - name: Install Appium
        run: npm install -g appium

      - name: Start up Appium
        run: |
          nohup appium --log-timestamp --log-no-colors > appium.log &
          appium driver install uiautomator2
          appium driver doctor uiautomator2

      - name: Install system-images via SDKManager
        run: |
          sdkmanager --channel=0 "system-images;android-34;google_apis;arm64-v8a"
          sdkmanager --channel=0 "system-images;android-34;google_apis;x86_64"
          sdkmanager --list_installed

      - name: Start up adb
        run: |
          adb start-server
          mkdir -p ~/.android/avd
          which avdmanager
          avdmanager -v list avd
          avdmanager -v create avd -n Pixel_3a_API_34 -k "system-images;android-34;google_apis;x86_64" -d pixel_3a
          echo -------
          emulator -list-avds
          echo -------

      - name: Checkout Eficode course
        uses: actions/checkout@v3
        with:
          repository: eficode-academy/rf-mobile-testing-appium
          path: eficode

      - name: Debug Step
        run: ls

      - name: Start Appium Server
        run: |
          nohup appium -p 4725 &

      - name: Start Android Emulator 1
        run: |
          echo "Starting AVD..."
          nohup emulator -avd Pixel_3a_API_34 -no-window -no-audio > emulator.log 2>&1 &

      - name: Start Android Emulator 2
        run: |
          adb devices

      - name: Run sample test
        run: robot -v APPIUM_PORT:4725 eficode/examples/simple/basics.robot

      - name: Archive appium log
        uses: actions/upload-artifact@v4
        with:
          name: appium-log
          path: appium.log